<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Chủ - Thời Khóa Biểu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --background-color: #23d5ab; }
        html, body { height: 100%; margin: 0; }
        body { font-family: 'Be Vietnam Pro', sans-serif; color: #fff; display: flex; flex-direction: column; min-height: 100vh; background-color: var(--background-color); background-image: radial-gradient(at 0% 0%, hsla(253, 100%, 70%, 0.1) 0px, transparent 50%), radial-gradient(at 99% 1%, hsla(339, 100%, 75%, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(205, 100%, 75%, 0.1) 0px, transparent 50%), radial-gradient(at 0% 100%, hsla(165, 100%, 75%, 0.1) 0px, transparent 50%); transition: background-color 0.5s ease; }
        .selection-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 40px; flex-grow: 1; padding: 20px; }
        .choice-card { width: 320px; height: 420px; padding: 30px; box-sizing: border-box; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2); text-align: center; display: flex; flex-direction: column; justify-content: space-around; align-items: center; transition: transform 0.3s ease, box-shadow 0.3s ease; text-decoration: none; color: #fff; cursor: pointer; }
        .choice-card:hover { transform: translateY(-12px); box-shadow: 0 16px 40px 0 rgba(31, 38, 135, 0.3); }
        .choice-card h2 { font-size: 2.2em; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); margin: 0; }
        .choice-card p { font-size: 1.1em; opacity: 0.9; }
        .choice-card .icon { font-size: 6em; color: rgba(255,255,255,0.9); text-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .card-button { padding: 14px 35px; border: 2px solid rgba(255, 255, 255, 0.7); border-radius: 50px; background: transparent; color: #fff; font-family: 'Be Vietnam Pro', sans-serif; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .card-button:hover { background: rgba(255, 255, 255, 0.2); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 40px; background: rgba(30, 30, 40, 0.8); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); position: relative; transform: scale(0.95); transition: transform 0.4s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.3); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background 0.3s, transform 0.3s; }
        .close-button:hover { background: rgba(255,0,0,0.5); transform: rotate(90deg); }
        .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 15px; }
        table { width: 100%; min-width: 800px; border-collapse: collapse; border-radius: 15px; overflow: hidden; }
        th, td { padding: 16px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap; }
        .main-header-row th { background: rgba(255, 255, 255, 0.2); font-weight: 700; font-size: 1.1em; }
        tr:not(.main-header-row):hover td { background-color: rgba(255, 255, 255, 0.1); }
        td.session-label { background-color: rgba(0, 0, 0, 0.3) !important; font-weight: bold; }
        #schedule-info { text-align: center; margin: 20px 0; font-size: 1.1em; opacity: 0.8;}
        .no-schedule { text-align: center; font-size: 1.2em; padding: 40px 20px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .modal-content h1, .modal-content h3 { text-align: center; }
        .modal-content h1 { font-size: 2em; } .modal-content h3 { font-size: 1.6em; margin-top: 30px; }
        .times-table { min-width: 0; margin-bottom: 30px; }
        .times-table th, .times-table td { padding: 15px; white-space: normal; }
        .times-table .break-row { background: rgba(0,0,0,0.2); font-style: italic; color: #a0a0a0; }
        .footer-credit { text-align: center; width: 100%; color: rgba(255, 255, 255, 0.7); font-size: 0.9em; padding: 20px 0; flex-shrink: 0; }
        .footer-credit a { color: rgba(255, 255, 255, 0.9); text-decoration: none; font-weight: bold; transition: color 0.3s; }
        .footer-credit a:hover { color: #fff; text-decoration: underline; }
        @media (max-width: 768px) { .modal-content { padding: 20px; } .close-button { top: 10px; right: 10px; width: 35px; height: 35px; } th, td { padding: 12px; font-size: 0.9em; } .times-table th, .times-table td { font-size: 0.9em; } }
    </style>
    <script>
        (function() {
            const savedColor = localStorage.getItem('tkb-background-color');
            if (savedColor) {
                document.documentElement.style.setProperty('--background-color', savedColor);
            }
        })();
    </script>
</head>
<body>
    <div id="loading-overlay" style="position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#232526 0%,#414345 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <svg width="100" height="100" viewBox="0 0 100 100">
            <defs>
                <linearGradient id="loader-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#4F46E5"/>
                    <stop offset="100%" stop-color="#23d5ab"/>
                </linearGradient>
                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            <circle cx="50" cy="50" r="40" stroke="url(#loader-gradient)" stroke-width="8" fill="none" opacity="0.2"/>
            <circle cx="50" cy="50" r="40" stroke="url(#loader-gradient)" stroke-width="8" fill="none"
                stroke-linecap="round"
                stroke-dasharray="220"
                stroke-dashoffset="180"
                filter="url(#glow)">
                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="1s" repeatCount="indefinite"/>
            </circle>
        </svg>
        <div style="margin-top:32px;font-size:1.5em;color:#fff;font-weight:600;letter-spacing:1px;text-shadow:0 2px 16px #4F46E5,0 0 8px #23d5ab;">
            <span id="loading-text">Đang tải dữ liệu</span><span class="dot">.</span>
        </div>
    </div>
    <style>
        @media (max-width: 600px) {
            #loading-overlay svg { width: 70px; height: 70px; }
            #loading-overlay div { font-size: 1.1em !important; }
        }
        #loading-overlay .dot {
            animation: dotPulse 1.2s infinite steps(3);
            font-size: 1.2em;
            color: #23d5ab;
            margin-left: 2px;
        }
        @keyframes dotPulse {
            0% { content: ""; opacity: 1; }
            33% { content: "."; opacity: 1; }
            66% { content: ".."; opacity: 1; }
            100% { content: "..."; opacity: 1; }
        }
    </style>
    <script>
        // Animation cho dấu chấm động
        (function animateDots() {
            const text = document.getElementById('loading-text');
            const dot = document.querySelector('#loading-overlay .dot');
            let count = 0;
            setInterval(() => {
                count = (count + 1) % 4;
                dot.textContent = '.'.repeat(count);
            }, 400);
        })();
    </script>
    <div class="selection-container">
        <div class="choice-card" id="view-schedule-card">
            <div class="icon"><i class="ph-fill ph-calendar-check"></i></div>
            <h2>Xem Thời Khóa Biểu</h2>
            <p>Xem lịch học chi tiết các ngày trong tuần.</p>
            <button class="card-button">Mở Lịch</button>
        </div>
        <div class="choice-card" id="view-times-card">
            <div class="icon"><i class="ph-fill ph-clock"></i></div>
            <h2>Thời Gian Tiết Học</h2>
            <p>Xem chi tiết thời gian vào lớp, ra chơi và tan học.</p>
            <button class="card-button">Xem Chi Tiết</button>
        </div>
    </div>
    <div class="modal-overlay" id="schedule-modal">
        <div class="modal-content">
            <button class="close-button" id="close-schedule-modal-btn">&times;</button>
            <h1>Thời Khóa Biểu</h1>
            <div id="schedule-info"></div>
            <div id="no-schedule-msg" class="no-schedule" style="display: none;">Chưa có TKB nào được cập nhật.</div>
            <div class="table-responsive-wrapper">
                <table id="schedule-table" style="display: none;">
                    <thead id="schedule-thead"></thead>
                    <tbody id="schedule-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="times-modal">
        <div class="modal-content" id="times-modal-content"></div>
    </div>
    <footer class="footer-credit">
        Made with ❤️ by <a href="https://github.com/mavrixdev" target="_blank">Mavrixdev</a>
    </footer>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Tải dữ liệu từ cache ngay khi trang được tải
        let latestScheduleEntry = JSON.parse(localStorage.getItem('tkb-latest-schedule'));
        let timesData = JSON.parse(localStorage.getItem('tkb-times-data'));

        // Render ngay lập tức với dữ liệu cache (nếu có)
        if (latestScheduleEntry) {
            renderSchedule(latestScheduleEntry);
        }
        if (timesData) {
            renderTimes(timesData);
        }

        // --- Các hàm tiện ích ---
        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        document.getElementById('view-schedule-card').addEventListener('click', () => openModal('schedule-modal'));
        document.getElementById('close-schedule-modal-btn').addEventListener('click', () => closeModal('schedule-modal'));
        document.getElementById('schedule-modal').addEventListener('click', (e) => { if (e.target.id === 'schedule-modal') closeModal('schedule-modal'); });
        document.getElementById('view-times-card').addEventListener('click', () => openModal('times-modal'));
        document.getElementById('times-modal').addEventListener('click', (e) => { if (e.target.id === 'times-modal') closeModal('times-modal'); });

        // --- Các hàm render ---
        function getColorForSubject(subject) { function hexToRgba(hex, alpha) { hex = hex.replace('#', ''); const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; } const subjectColors = { 'toán': '#89cff0', 'vật lý': '#f3a683', 'hóa học': '#a8e6cf', 'sinh học': '#9bcfb5', 'công nghệ': '#dcdde1', 'văn': '#f8c291', 'văn cđ': '#f8c291', 'lịch sử': '#e5b4b4', 'sử cđ': '#e5b4b4', 'địa lý': '#b2d8b2', 'địa cđ': '#b2d8b2', 'giáo dục công dân': '#cfb4e5', 'hđtn': '#cfb4e5', 'tiếng anh': '#c7d3e1', 'thể dục': '#f1cb7d', 'chào cờ': '#ffb6c1', 'shl': '#f5f5dc', }; const lowerCaseSubject = subject.toLowerCase().trim(); if (!lowerCaseSubject) return 'rgba(255, 255, 255, 0.05)'; if (subjectColors[lowerCaseSubject]) { return hexToRgba(subjectColors[lowerCaseSubject], 0.4); } return 'rgba(255, 255, 255, 0.1)'; }
        function renderSchedule(scheduleEntry) { const noMsg = document.getElementById('no-schedule-msg'); const table = document.getElementById('schedule-table'); const infoDiv = document.getElementById('schedule-info'); if (!scheduleEntry || !scheduleEntry.schedule) { noMsg.style.display = 'block'; table.style.display = 'none'; infoDiv.style.display = 'none'; return; } noMsg.style.display = 'none'; table.style.display = 'table'; infoDiv.style.display = 'block'; const { schedule, timestamp } = scheduleEntry; const date = new Date(timestamp).toLocaleString('vi-VN'); infoDiv.innerHTML = `Bản cập nhật mới nhất lúc: <strong>${date}</strong>`; const numPeriodsPerSession = 5; const thead = document.getElementById('schedule-thead'); const tbody = document.getElementById('schedule-tbody'); thead.innerHTML = ''; tbody.innerHTML = ''; const headerRow = document.createElement('tr'); headerRow.className = 'main-header-row'; headerRow.innerHTML = '<th>Buổi / Tiết</th>'; schedule.forEach(item => { headerRow.innerHTML += `<th>${item.day}</th>`; }); thead.appendChild(headerRow); for (let i = 0; i < numPeriodsPerSession * 2; i++) { const isMorning = i < numPeriodsPerSession; const periodNum = isMorning ? i + 1 : i - numPeriodsPerSession + 1; const sessionLabel = isMorning ? 'Sáng' : 'Chiều'; const row = document.createElement('tr'); row.innerHTML = `<td class="session-label">${periodNum} (${sessionLabel})</td>`; schedule.forEach(day => { const period = day.periods[i] || ''; const color = getColorForSubject(period); row.innerHTML += `<td style="background-color: ${color};">${period}</td>`; }); tbody.appendChild(row); } }
        function renderTimes(timesData) { if (!timesData) return; const contentDiv = document.getElementById('times-modal-content'); let html = `<button class="close-button" onclick="closeModal('times-modal')">&times;</button><h1>THỜI GIAN CÁC TIẾT HỌC</h1><p style="text-align: center; font-size: 1.2em;">${timesData.title || ''}</p><h3>Buổi Sáng</h3><table class="times-table"><thead><tr><th>Thời gian</th><th>Thời lượng</th><th>Nội dung</th></tr></thead><tbody>`; (timesData.morning || []).forEach(row => { html += `<tr class="${row.isBreak ? 'break-row' : ''}"><td>${row.time}</td><td>${row.duration}</td><td>${row.content}</td></tr>`; }); html += `</tbody></table><h3>Buổi Chiều</h3><table class="times-table"><thead><tr><th>Thời gian</th><th>Thời lượng</th><th>Nội dung</th></tr></thead><tbody>`; (timesData.afternoon || []).forEach(row => { html += `<tr class="${row.isBreak ? 'break-row' : ''}"><td>${row.time}</td><td>${row.duration}</td><td>${row.content}</td></tr>`; }); html += `</tbody></table>`; contentDiv.innerHTML = html; }
        
        // Lắng nghe sự kiện từ server để cập nhật và lưu cache mới
        socket.on('latestSchedule', (newScheduleEntry) => {
            renderSchedule(newScheduleEntry);
            localStorage.setItem('tkb-latest-schedule', JSON.stringify(newScheduleEntry));
            hideLoading(); // Ẩn loading khi đã nhận được dữ liệu
        });
        socket.on('updateTimes', (newTimesData) => {
            renderTimes(newTimesData);
            localStorage.setItem('tkb-times-data', JSON.stringify(newTimesData));
            hideLoading();
        });
        socket.on('updateSettings', (newSettings) => { 
            // Title
            if (newSettings.pageTitle) {
                document.title = newSettings.pageTitle;
                // Nếu có thẻ og:title thì cập nhật luôn
                let ogTitle = document.querySelector("meta[property='og:title']");
                if (ogTitle) ogTitle.content = newSettings.pageTitle;
            }
            // Background color
            const newColor = newSettings.backgroundColor || '#f0f8ff';
            document.documentElement.style.setProperty('--background-color', newColor);
            localStorage.setItem('tkb-background-color', newColor);

            // Favicon
            if (newSettings.favicon) {
                let link = document.querySelector("link[rel~='icon']");
                if (!link) {
                    link = document.createElement('link');
                    link.rel = 'icon';
                    document.head.appendChild(link);
                }
                link.href = newSettings.favicon;
            }
            // OG Title
            if (newSettings.ogTitle) {
                let meta = document.querySelector("meta[property='og:title']");
                if (!meta) {
                    meta = document.createElement('meta');
                    meta.setAttribute('property', 'og:title');
                    document.head.appendChild(meta);
                }
                meta.content = newSettings.ogTitle;
            }
            // OG Description
            if (newSettings.ogDescription) {
                let meta = document.querySelector("meta[property='og:description']");
                if (!meta) {
                    meta = document.createElement('meta');
                    meta.setAttribute('property', 'og:description');
                    document.head.appendChild(meta);
                }
                meta.content = newSettings.ogDescription;
            }
            // Canonical
            if (newSettings.canonical) {
                let link = document.querySelector("link[rel='canonical']");
                if (!link) {
                    link = document.createElement('link');
                    link.rel = 'canonical';
                    document.head.appendChild(link);
                }
                link.href = newSettings.canonical;
            }
            // Keywords
            if (newSettings.keywords) {
                let meta = document.querySelector("meta[name='keywords']");
                if (!meta) {
                    meta = document.createElement('meta');
                    meta.name = 'keywords';
                    document.head.appendChild(meta);
                }
                meta.content = newSettings.keywords;
            }
        });

        let loadingDone = false;
        let loadingStart = Date.now();
        function hideLoading() {
            if (!loadingDone) {
                loadingDone = true;
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
    </script>
</body>
</html>
